<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard</title>

  <style>
    /* ===============================
    TB4 Monitor (moved from robot_display)
    =============================== */
    .tb4-grid {
      display: grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 12px;
    }

    .tb4-card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      padding: 16px;
    }

    .tb4-title { margin:0 0 12px 0; font-size:16px; font-weight:900; }

    .tb4-kv {
      display: grid;
      grid-template-columns: 150px 1fr;
      gap: 10px;
      font-size: 14px;
      align-items: start;
    }

    .tb4-k { color:#374151; font-weight:700; }
    .tb4-v { color:#111; }

    .tb4-pill {
      display:inline-flex; align-items:center;
      padding:4px 10px; border-radius:999px;
      font-size:12px; font-weight:800;
      background:#eef2ff; color:#3730a3;
    }
    .tb4-pill.green { background:#dcfce7; color:#166534; }
    .tb4-pill.red   { background:#fee2e2; color:#991b1b; }
    .tb4-pill.amber { background:#fef3c7; color:#92400e; }

    .tb4-progress-wrap { display:flex; align-items:center; gap:10px; }
    .tb4-progress {
      width: 260px; max-width: 100%;
      height: 10px; background:#e5e7eb;
      border-radius:999px; overflow:hidden;
    }
    .tb4-progress > div { height:100%; width:0%; background:#22c55e; }

    .tb4-mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .tb4-log {
      height: 260px; overflow:auto; background:#0b1220; color:#dbeafe;
      border-radius:10px; padding:12px; font-size:12px; line-height:1.5;
    }
    .tb4-log .row { border-bottom: 1px solid rgba(255,255,255,0.08); padding:6px 0; }

    @media (max-width: 900px) {
      .tb4-grid { grid-template-columns: 1fr; }
      .tb4-progress { width: 100%; }
    }

    /* ===============================
       Global
    =============================== */
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #f3f4f6;
      color: #111;
    }

    /* ===============================
       Header
    =============================== */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      height: 60px;
      padding: 0 24px;
      background-color: #1f2933;
      color: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .header-left {
      font-size: 18px;
      font-weight: bold;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 14px;
    }

    .nav-link{
      padding: 6px 14px;
      background-color: #0ea5e9;
      color: white;
      text-decoration: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 700;
    }
    
    .nav-link:hover { filter: brightness(0.95); }

    .logout-link {
      padding: 6px 14px;
      background-color: #4CAF50;
      color: white;
      text-decoration: none;
      border-radius: 4px;
      font-size: 14px;
    }
    .logout-link:hover { background-color: #45a049; }

    /* ===============================
       Video (Top)
       - ë¼ë²¨ í•˜ë‹¨ ê³ ì •: ì¹´ë“œ ë†’ì´ ê³ ì • + column flex
    =============================== */
    .top-video-wrapper {
      width: 100%;
      background-color: #111;
      padding: 10px;
      box-sizing: border-box;
    }

    .video-container {
      display: flex;
      gap: 10px;
      width: 100%;
    }

    /* âœ… ê³ ì • ë†’ì´: ë¼ë²¨ ìœ„ì¹˜ ì•ˆì •í™” */
    .video-card {
      flex: 1;
      display: flex;
      flex-direction: column;
      border-radius: 6px;
      overflow: hidden;
      background: #000;
      min-width: 0;
      height: 280px; /* í•„ìš”ì‹œ 320/360 ë“±ìœ¼ë¡œ ì¡°ì • */
    }

    /* ì˜ìƒ ì˜ì—­(ìˆìœ¼ë©´ img, ì—†ìœ¼ë©´ placeholder) */
    .video-stage {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
      min-height: 0;
    }

    .video-stage img {
      width: 100%;
      height: 100%;
      object-fit: cover; /* ê½‰ ì±„ìš°ê¸° */
      display: block;
    }

    /* âœ… Cameraê°€ ì—†ì„ ë•Œë„ ë¼ë²¨ì€ í•˜ë‹¨ ìœ ì§€ */
    .video-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #bbb;
      font-size: 14px;
      background: #000;
    }

    .camera-label {
      height: 36px;              /* âœ… ë¼ë²¨ ë†’ì´ ê³ ì • */
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 10px;
      font-size: 14px;
      background-color: #1f2933;
      color: #fff;
      flex: 0 0 auto;
    }

    /* ===============================
       Layout: Middle + Bottom
    =============================== */
    .page {
      width: 100%;
      padding: 10px;
      box-sizing: border-box;
    }

  
    /* Middle section */
    .middle {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 12px;
      margin-top: 16px;
    }

    .card {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      padding: 16px;
    }

    .card-title {
      margin: 0 0 12px 0;
      font-size: 16px;
      font-weight: 700;
      color: #111;
    }

    .subtle {
      font-size: 12px;
      color: #6b7280;
      margin-left: 8px;
      font-weight: 500;
    }

    .kv {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 10px;
      font-size: 14px;
      align-items: start;
    }

    .kv .k {
      color: #374151;
      font-weight: 600;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      background: #eef2ff;
      color: #3730a3;
    }

    .pill.red   { background: #fee2e2; color: #991b1b; }
    .pill.green { background: #dcfce7; color: #166534; }
    .pill.amber { background: #fef3c7; color: #92400e; }

    .dispatch {
      display: flex;
      flex-direction: column;
      gap: 10px;
      height: 100%;
    }

    .btn {
      width: 100%;
      padding: 12px 14px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 800;
      font-size: 14px;
    }

    .btn-primary {
      background: #2563eb;
      color: white;
    }
    .btn-primary:hover { filter: brightness(0.95); }

    .btn-outline {
      background: white;
      border: 1px solid #d1d5db;
      color: #111;
    }
    .btn-outline:hover { background: #f9fafb; }

    /* Bottom section: robot statuses */
    .bottom {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }

    .robot-row {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      margin-top: 10px;
      font-size: 14px;
    }

    .progress {
      width: 60%;
      height: 10px;
      background: #e5e7eb;
      border-radius: 999px;
      overflow: hidden;
    }

    .progress > div {
      height: 100%;
      width: 0%; /* ë°°í„°ë¦¬ ê°’ì— ë”°ë¼ ë³€ê²½ */
      background: #22c55e;
    }

    .muted {
      font-size: 12px;
      color: #6b7280;
      margin-top: 8px;
    }

    /* Responsive */
    @media (max-width: 900px) {
      .video-container { flex-direction: column; }
      .video-card { height: 260px; }
      .middle { grid-template-columns: 1fr; }
      .bottom { grid-template-columns: 1fr; }
    }

    /* ===============================
    Bottom Fixed Action Bar
    =============================== */
    .bottom-action-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;

      display: flex;
      justify-content: center;
      gap: 16px;

      padding: 12px 16px;
      background: rgba(31, 41, 51, 0.95); /* í—¤ë” ìƒ‰ ê³„ì—´ */
      backdrop-filter: blur(6px);

      box-shadow: 0 -2px 8px rgba(0,0,0,0.25);
      z-index: 1000;
    }

    /* ë²„íŠ¼ í¬ê¸° í†µì¼ */
    .bottom-action-bar .btn {
      min-width: 140px;
      font-size: 14px;
      font-weight: 800;
    }

    /* í˜ì´ì§€ ë‚´ìš©ì´ ë²„íŠ¼ì— ê°€ë¦¬ì§€ ì•Šê²Œ í•˜ë‹¨ ì—¬ë°± í™•ë³´ */
    .page {
      padding-bottom: 80px;  /* action bar ë†’ì´ë³´ë‹¤ í¬ê²Œ */
    }
  </style>
</head>

<body>

  <!-- Header -->
  <header class="header">
    <div class="header-left">My Dashboard</div>
    <div class="header-right">
      <!-- <a href="{{ url_for('robot_display') }}" class="nav-link">TB4 Monitor</a> -->
      <span>ğŸ‘¤ {{ username }}</span>
      <a href="{{ url_for('logout') }}" class="logout-link">Logout</a>
    </div>
  </header>

  <!-- Top: Videos -->
  <section class="top-video-wrapper">
    <div class="video-container">

      <!-- Camera 1 -->
      <div class="video-card">
        <div class="video-stage">
          <img src="/video_feed1">
          <!-- <img src="{{ url_for('video_feed1') }}" alt="Camera 1"> -->
        </div>
        <div class="camera-label">Camera 1</div>
      </div>

      <!-- Camera 2 -->
      <div class="video-card">
        <div class="video-stage">
          <img src="/video_feed2">
          <!-- <img src="{{ url_for('video_feed2') }}" alt="Camera 2"> -->
        </div>
        <div class="camera-label">Camera 2</div>
      </div>

      <!-- Camera 3 -->
      <div class="video-card">
        <div class="video-stage">
          <img src="/video_feed3">
          <!-- <img src="{{ url_for('video_feed3') }}" alt="Camera 3"> -->
        </div>
        <div class="camera-label">Camera 3</div>
      </div>

    </div>
  </section>

  <!-- Middle + Bottom -->
  <main class="page">

    <!-- ===============================
         ì¤‘ê°„: ìƒí™© + ë¡œë´‡ ì¶œë™ ë²„íŠ¼
    =============================== -->
    <section class="middle">

      <!-- ìƒí™© ë°œìƒ ì¹´ë“œ -->
      <div class="card ">
        <div class="card-title">
          ìƒí™© ë°œìƒ <span class="subtle"></span>
        </div>

        <div class="kv">
          <div class="k">ì¢Œí‘œ</div>
          <div class="v">{{ incident_coord | default("N/A (ì˜ˆ: x=12.3, y=4.5)") }}</div>

          <div class="k">í˜„ì¬ ìƒí™©</div>
          <div class="v">
            <!-- ì˜ˆ: í™”ì¬ ì§„ì••ì¤‘ / ì§„ì•• ì™„ë£Œ / ì‚¬ëŒ ë””í…ì…˜ -->
            <span class="pill amber">{{ incident_status | default("ì‚¬ëŒ ë””í…ì…˜") }}</span>
          </div>

          <div class="k">ì„¸ë¶€</div>
          <div class="v">{{ incident_detail | default("ì˜ˆ: í™”ì¬ ë°œìƒ ì§€ì  ì ‘ê·¼ ì¤‘ / ì—°ê¸° ê°ì§€") }}</div>

        </div>
      </div>

      <!-- ë¡œë´‡ ì¶œë™ ì¹´ë“œ -->
      <!-- <div class="card ">
        <div class="card-title">
        </div>
      <div style="display:flex; gap:10px; align-items:center;">
        <button class="btn btn-outline" onclick="stopAlarm()">ê²½ë³´ ì¢…ë£Œ</button>
        <button id="btnReturnHome" class="btn btn-warning" type="button">ë³µê·€ ìš”ì²­</button>
      </div> -->


        <!-- ì‹¤ì œë¡œëŠ” ë²„íŠ¼ í´ë¦­ì´ POSTë¥¼ ë•Œë¦¬ê²Œ í•˜ëŠ” ê²Œ ì •ì„
        <form method="POST" action="{{ url_for('dispatch_robot') }}">
          <button class="btn btn-primary" type="submit">ë¡œë´‡ ì¶œë™</button>
        </form> -->
      </div>

    </section>

    <!-- ===============================
         í•˜ë‹¨: ë¡œë´‡ ìƒíƒœ A/B
    =============================== -->
    <section class="bottom">

      <!-- ë¡œë´‡A -->
      <div class="card ">
        <div class="card-title">ë¡œë´‡A ìƒíƒœ</div>

        <div class="robot-row">
          <div><strong>ë°°í„°ë¦¬</strong></div>
          <div style="display:flex; align-items:center; gap:10px; width:70%;">
            <div class="progress">
              <div style="width: {{ robotB_battery}}%"></div>
            </div>



            <div style="min-width:52px; text-align:right;">
              {{ robotA_battery | default(0) }}%
            </div>
          </div>
        </div>

      </div>

      <!-- ë¡œë´‡B -->
      <div class="card ">
        <div class="card-title">ë¡œë´‡B ìƒíƒœ</div>

        <div class="robot-row">
          <div><strong>ë°°í„°ë¦¬</strong></div>
          <div style="display:flex; align-items:center; gap:10px; width:70%;">
            <div class="progress">
                <div style="width: {{ robotB_battery}}%"></div>
            </div>

            <div style="min-width:52px; text-align:right;">
              {{ robotB_battery | default(0)}}%
            </div>
          </div>
        </div>

      </div>

    </section>

    <section style="margin-top: 12px;">
      <div class="tb4-grid">

        <!-- LEFT: Status -->
        <div class="tb4-card">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
            <h2 class="tb4-title" style="margin:0;">í„°í‹€ë´‡4 ìƒíƒœ</h2>

            <div style="display:flex; align-items:center; gap:10px;">
              <span class="tb4-mono" id="tb4_ns">/robot6</span>
              <span id="tb4_connected" class="tb4-pill amber">CHECKING</span>
            </div>
          </div>

          <div class="tb4-kv" style="margin-top:12px;">
            <div class="tb4-k">ë§ˆì§€ë§‰ ìˆ˜ì‹ </div>
            <div class="tb4-v"><span id="tb4_last_seen" class="tb4-mono">-</span></div>

            <div class="tb4-k">ë°°í„°ë¦¬</div>
            <div class="tb4-v">
              <div class="tb4-progress-wrap">
                <div class="tb4-progress"><div id="tb4_batt_bar"></div></div>
                <div style="min-width:70px; text-align:right;">
                  <span id="tb4_batt_text" class="tb4-mono">0%</span>
                </div>
              </div>
              <div style="margin-top:8px; font-size:12px; color:#6b7280;">
                voltage: <span id="tb4_volt" class="tb4-mono">-</span> V,
                current: <span id="tb4_curr" class="tb4-mono">-</span> A
              </div>
            </div>

            <div class="tb4-k">Pose Frame</div>
            <div class="tb4-v"><span id="tb4_pose_frame" class="tb4-mono">map</span></div>

            <div class="tb4-k">ìœ„ì¹˜ (x, y)</div>
            <div class="tb4-v">
              x=<span id="tb4_x" class="tb4-mono">0.00</span>,
              y=<span id="tb4_y" class="tb4-mono">0.00</span>
            </div>

            <div class="tb4-k">Yaw</div>
            <div class="tb4-v"><span id="tb4_yaw" class="tb4-mono">0.0</span> Â°</div>

            <div class="tb4-k">ì†ë„ (v, w)</div>
            <div class="tb4-v">
              v=<span id="tb4_lin" class="tb4-mono">0.00</span> m/s,
              w=<span id="tb4_ang" class="tb4-mono">0.00</span> rad/s
            </div>
          </div>
        </div>

        <!-- RIGHT: Live log -->
        <div class="tb4-card">
          <h2 class="tb4-title">ìµœê·¼ ì´ë²¤íŠ¸</h2>
          <div id="tb4_log" class="tb4-log"></div>
          <div style="font-size:12px; color:#6b7280; margin-top:8px;">
            * SSE ì—°ê²°ì´ ì•ˆ ë˜ë©´ ë¡œê·¸ê°€ ë¹„ì–´ìˆì„ ìˆ˜ ìˆì–´ìš”. (í´ë§ì€ ê³„ì† ë™ì‘)
          </div>
        </div>

      </div>
    </section>



    <!-- âœ… í•˜ë‹¨ ê³ ì • ì•¡ì…˜ ë°” -->
    <div class="bottom-action-bar">
      <button class="btn btn-outline" onclick="stopAlarm()">ê²½ë³´ ì¢…ë£Œ</button>
      <button id="btnReturnHome" class="btn btn-warning" type="button">ë³µê·€ ìš”ì²­</button>
    </div>

  </main>

  
  <div id="snackbar" style="
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #333;
    color: #fff;
    padding: 12px 16px;
    border-radius: 8px;
    display: none;
    z-index: 9999;
    font-size: 14px;">
  </div>

</body>

<script>
  // âœ… ì¶”ê°€: ë³µê·€ ìš”ì²­ API í˜¸ì¶œ
  document.getElementById("btnReturnHome")?.addEventListener("click", async () => {
    try {
      const res = await fetch("/api/return_home", { method: "POST" });
      const data = await res.json();

      if (!res.ok || !data.ok) throw new Error(data.error || "request failed");
      alert("ë³µê·€ ìš”ì²­ ì „ì†¡ ì™„ë£Œ");
      console.log(data)

    } catch (e) {
      console.error(e);
      alert("ë³µê·€ ìš”ì²­ ì‹¤íŒ¨");
    }
  });
</script>

<script>
  // dashboard ë“¤ì–´ì˜¤ë©´ ì¹´ë©”ë¼ ON ë³´ì¥
  fetch("/api/cameras/start", { method: "POST" }).catch(()=>{});
</script>

<script src="{{ url_for('static', filename='js/events.js') }}"></script>


<script>
  async function stopAlarm(){
    try{
      const res = await fetch("/api/alarm/stop", {method:"POST"});
      if(res.ok){
        // í•„ìš”í•˜ë©´ í† ìŠ¤íŠ¸/ìŠ¤ë‚µë°” í‘œì‹œ
        console.log("alarm stopped");
      }
    }catch(e){}
  }
</script>

<script>
  function clamp(n){ n = parseInt(n,10); return isNaN(n)?0:Math.max(0,Math.min(100,n)); }

  async function refreshStatus(){

    console.log('eaaergaergaerg')
    try{
      const res = await fetch("/api/status", {cache:"no-store"});
      if(!res.ok) return;
      const data = await res.json();

      const a = clamp(data.robotA_battery);
      const b = clamp(data.robotB_battery);

      document.getElementById("robotA_bar").style.width = a + "%";
      document.getElementById("robotA_text").textContent = a + "%";

      document.getElementById("robotB_bar").style.width = b + "%";
      document.getElementById("robotB_text").textContent = b + "%";

      // ì„ íƒ: ë°°í„°ë¦¬ ìƒ‰ ìë™ ë³€ê²½
      document.getElementById("robotA_bar").style.background = (a <= 20) ? "#ef4444" : "#22c55e";
      document.getElementById("robotB_bar").style.background = (b <= 20) ? "#ef4444" : "#f59e0b";

    }catch(e){}
  }

  refreshStatus(); // ì²« ë¡œë“œ ì¦‰ì‹œ ê°±ì‹ 
  setInterval(refreshStatus, 2000); // 2ì´ˆë§ˆë‹¤ ê°±ì‹ 
</script>



<script>
  // -----------------------------
  // TB4 helpers
  // -----------------------------
  function clamp(n){ n = parseInt(n,10); return isNaN(n)?0:Math.max(0,Math.min(100,n)); }
  function fmtTs(sec){
    if(!sec || sec <= 0) return "-";
    const d = new Date(sec * 1000);
    return d.toLocaleString();
  }
  function setText(id, v){
    const el = document.getElementById(id);
    if(!el) return;
    el.textContent = (v === null || v === undefined || v === "") ? "-" : String(v);
  }
  function toFixedMaybe(v, digits){
    if(v === null || v === undefined) return "-";
    if(typeof v === "number") return v.toFixed(digits);
    const f = Number(v);
    return isNaN(f) ? String(v) : f.toFixed(digits);
  }

  // -----------------------------
  // Polling: /api/tb4_status
  // -----------------------------
  async function refreshTB4(){
    try{
      const res = await fetch("/api/tb4_status", {cache:"no-store"});
      if(!res.ok) return;
      const d = await res.json();

      setText("tb4_ns", d.robot_ns ?? "/robot6");

      // connected pill
      const pill = document.getElementById("tb4_connected");
      if(pill){
        if(d.connected){
          pill.textContent = "CONNECTED";
          pill.className = "tb4-pill green";
        }else{
          pill.textContent = "DISCONNECTED";
          pill.className = "tb4-pill red";
        }
      }

      setText("tb4_last_seen", fmtTs(d.last_seen_ts));
      setText("tb4_pose_frame", d.pose_frame ?? "map");

      // battery
      const batt = clamp(d.battery_percent ?? 0);
      const bar = document.getElementById("tb4_batt_bar");
      const text = document.getElementById("tb4_batt_text");
      if(bar) bar.style.width = batt + "%";
      if(text) text.textContent = batt + "%";

      // color
      if(bar){
        bar.style.background = (batt <= 20) ? "#ef4444" : (batt <= 50) ? "#f59e0b" : "#22c55e";
      }

      setText("tb4_volt", toFixedMaybe(d.battery_voltage, 2));
      setText("tb4_curr", toFixedMaybe(d.battery_current, 2));

      setText("tb4_x", toFixedMaybe(d.x, 2));
      setText("tb4_y", toFixedMaybe(d.y, 2));
      setText("tb4_yaw", toFixedMaybe(d.yaw_deg, 1));
      setText("tb4_lin", toFixedMaybe(d.lin_vel, 2));
      setText("tb4_ang", toFixedMaybe(d.ang_vel, 2));

    }catch(e){}
  }

  refreshTB4();
  setInterval(refreshTB4, 500);

  // -----------------------------
  // SSE: /tb4_events (ì„ íƒ)
  // -----------------------------
  const logEl = document.getElementById("tb4_log");
  function pushLog(obj){
    if(!logEl) return;
    const row = document.createElement("div");
    row.className = "row tb4-mono";
    const ts = obj.ts ? fmtTs(obj.ts) : "-";
    row.textContent = `[${ts}] ${obj.type || "event"} ` + JSON.stringify(obj);
    logEl.prepend(row);

    // trim
    const rows = logEl.querySelectorAll(".row");
    if(rows.length > 60){
      for(let i=60; i<rows.length; i++) rows[i].remove();
    }
  }

  try{
    const es = new EventSource("/tb4_events");
    es.addEventListener("tb4", (e) => {
      const ev = JSON.parse(e.data);
      pushLog(ev);
    });
    es.addEventListener("ping", () => {});
    es.onerror = () => {};
  }catch(e){}
</script>


</html>
