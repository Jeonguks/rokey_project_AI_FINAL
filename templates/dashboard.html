<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard</title>

  <style>
    /* ===============================
       Global
    =============================== */
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #f3f4f6;
      color: #111;
    }

    /* ===============================
       Header
    =============================== */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      height: 60px;
      padding: 0 24px;
      background-color: #1f2933;
      color: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .header-left {
      font-size: 18px;
      font-weight: bold;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 14px;
    }

    .nav-link{
      padding: 6px 14px;
      background-color: #0ea5e9;
      color: white;
      text-decoration: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 700;
    }
    
    .nav-link:hover { filter: brightness(0.95); }

    .logout-link {
      padding: 6px 14px;
      background-color: #4CAF50;
      color: white;
      text-decoration: none;
      border-radius: 4px;
      font-size: 14px;
    }
    .logout-link:hover { background-color: #45a049; }

    /* ===============================
       Video (Top)
       - ë¼ë²¨ í•˜ë‹¨ ê³ ì •: ì¹´ë“œ ë†’ì´ ê³ ì • + column flex
    =============================== */
    .top-video-wrapper {
      width: 100%;
      background-color: #111;
      padding: 10px;
      box-sizing: border-box;
    }

    .video-container {
      display: flex;
      gap: 10px;
      width: 100%;
    }

    /* âœ… ê³ ì • ë†’ì´: ë¼ë²¨ ìœ„ì¹˜ ì•ˆì •í™” */
    .video-card {
      flex: 1;
      display: flex;
      flex-direction: column;
      border-radius: 6px;
      overflow: hidden;
      background: #000;
      min-width: 0;
      height: 280px; /* í•„ìš”ì‹œ 320/360 ë“±ìœ¼ë¡œ ì¡°ì • */
    }

    /* ì˜ìƒ ì˜ì—­(ìˆìœ¼ë©´ img, ì—†ìœ¼ë©´ placeholder) */
    .video-stage {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
      min-height: 0;
    }

    .video-stage img {
      width: 100%;
      height: 100%;
      object-fit: cover; /* ê½‰ ì±„ìš°ê¸° */
      display: block;
    }

    /* âœ… Cameraê°€ ì—†ì„ ë•Œë„ ë¼ë²¨ì€ í•˜ë‹¨ ìœ ì§€ */
    .video-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #bbb;
      font-size: 14px;
      background: #000;
    }

    .camera-label {
      height: 36px;              /* âœ… ë¼ë²¨ ë†’ì´ ê³ ì • */
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 10px;
      font-size: 14px;
      background-color: #1f2933;
      color: #fff;
      flex: 0 0 auto;
    }

    /* ===============================
       Layout: Middle + Bottom
    =============================== */
    .page {
      width: 100%;
      padding: 10px;
      box-sizing: border-box;
    }

  
    /* Middle section */
    .middle {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 12px;
      margin-top: 16px;
    }

    .card {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      padding: 16px;
    }

    .card-title {
      margin: 0 0 12px 0;
      font-size: 16px;
      font-weight: 700;
      color: #111;
    }

    .subtle {
      font-size: 12px;
      color: #6b7280;
      margin-left: 8px;
      font-weight: 500;
    }

    .kv {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 10px;
      font-size: 14px;
      align-items: start;
    }

    .kv .k {
      color: #374151;
      font-weight: 600;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      background: #eef2ff;
      color: #3730a3;
    }

    .pill.red   { background: #fee2e2; color: #991b1b; }
    .pill.green { background: #dcfce7; color: #166534; }
    .pill.amber { background: #fef3c7; color: #92400e; }

    .dispatch {
      display: flex;
      flex-direction: column;
      gap: 10px;
      height: 100%;
    }

    .btn {
      width: 100%;
      padding: 12px 14px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 800;
      font-size: 14px;
    }

    .btn-primary {
      background: #2563eb;
      color: white;
    }
    .btn-primary:hover { filter: brightness(0.95); }

    .btn-outline {
      background: white;
      border: 1px solid #d1d5db;
      color: #111;
    }
    .btn-outline:hover { background: #f9fafb; }

    /* Bottom section: robot statuses */
    .bottom {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }

    .robot-row {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      margin-top: 10px;
      font-size: 14px;
    }

    .progress {
      width: 60%;
      height: 10px;
      background: #e5e7eb;
      border-radius: 999px;
      overflow: hidden;
    }

    .progress > div {
      height: 100%;
      width: 0%; /* ë°°í„°ë¦¬ ê°’ì— ë”°ë¼ ë³€ê²½ */
      background: #22c55e;
    }

    .muted {
      font-size: 12px;
      color: #6b7280;
      margin-top: 8px;
    }

    /* Responsive */
    @media (max-width: 900px) {
      .video-container { flex-direction: column; }
      .video-card { height: 260px; }
      .middle { grid-template-columns: 1fr; }
      .bottom { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>

  <!-- Header -->
  <header class="header">
    <div class="header-left">My Dashboard</div>
    <div class="header-right">
      <a href="{{ url_for('robot_display') }}" class="nav-link">TB4 Monitor</a>
      <span>ğŸ‘¤ {{ username }}</span>
      <a href="{{ url_for('logout') }}" class="logout-link">Logout</a>
    </div>
  </header>

  <!-- Top: Videos -->
  <section class="top-video-wrapper">
    <div class="video-container">

      <!-- Camera 1 -->
      <div class="video-card">
        <div class="video-stage">
          <img src="/video_feed1">
          <!-- <img src="{{ url_for('video_feed1') }}" alt="Camera 1"> -->
        </div>
        <div class="camera-label">Camera 1</div>
      </div>

      <!-- Camera 2 -->
      <div class="video-card">
        <div class="video-stage">
          <img src="/video_feed2">
          <!-- <img src="{{ url_for('video_feed2') }}" alt="Camera 2"> -->
        </div>
        <div class="camera-label">Camera 2</div>
      </div>

      <!-- Camera 3 -->
      <div class="video-card">
        <div class="video-stage">
          <img src="/video_feed3">
          <!-- <img src="{{ url_for('video_feed3') }}" alt="Camera 3"> -->
        </div>
        <div class="camera-label">Camera 3</div>
      </div>

    </div>
  </section>

  <!-- Middle + Bottom -->
  <main class="page">

    <!-- ===============================
         ì¤‘ê°„: ìƒí™© + ë¡œë´‡ ì¶œë™ ë²„íŠ¼
    =============================== -->
    <section class="middle">

      <!-- ìƒí™© ë°œìƒ ì¹´ë“œ -->
      <div class="card ">
        <div class="card-title">
          ìƒí™© ë°œìƒ <span class="subtle"></span>
        </div>

        <div class="kv">
          <div class="k">ì¢Œí‘œ</div>
          <div class="v">{{ incident_coord | default("N/A (ì˜ˆ: x=12.3, y=4.5)") }}</div>

          <div class="k">í˜„ì¬ ìƒí™©</div>
          <div class="v">
            <!-- ì˜ˆ: í™”ì¬ ì§„ì••ì¤‘ / ì§„ì•• ì™„ë£Œ / ì‚¬ëŒ ë””í…ì…˜ -->
            <span class="pill amber">{{ incident_status | default("ì‚¬ëŒ ë””í…ì…˜") }}</span>
          </div>

          <div class="k">ì„¸ë¶€</div>
          <div class="v">{{ incident_detail | default("ì˜ˆ: í™”ì¬ ë°œìƒ ì§€ì  ì ‘ê·¼ ì¤‘ / ì—°ê¸° ê°ì§€") }}</div>

        </div>
      </div>

      <!-- ë¡œë´‡ ì¶œë™ ì¹´ë“œ -->
      <div class="card ">
        <div class="card-title">
        </div>
      <div style="display:flex; gap:10px; align-items:center;">
        <button class="btn btn-outline" onclick="stopAlarm()">ê²½ë³´ ì¢…ë£Œ</button>
        <button id="btnReturnHome" class="btn btn-warning" type="button">ë³µê·€ ìš”ì²­</button>
      </div>


        <!-- ì‹¤ì œë¡œëŠ” ë²„íŠ¼ í´ë¦­ì´ POSTë¥¼ ë•Œë¦¬ê²Œ í•˜ëŠ” ê²Œ ì •ì„
        <form method="POST" action="{{ url_for('dispatch_robot') }}">
          <button class="btn btn-primary" type="submit">ë¡œë´‡ ì¶œë™</button>
        </form> -->
      </div>

    </section>

    <!-- ===============================
         í•˜ë‹¨: ë¡œë´‡ ìƒíƒœ A/B
    =============================== -->
    <section class="bottom">

      <!-- ë¡œë´‡A -->
      <div class="card ">
        <div class="card-title">ë¡œë´‡A ìƒíƒœ</div>

        <div class="robot-row">
          <div><strong>ë°°í„°ë¦¬</strong></div>
          <div style="display:flex; align-items:center; gap:10px; width:70%;">
            <div class="progress">
              <div style="width: {{ robotB_battery}}%"></div>
            </div>



            <div style="min-width:52px; text-align:right;">
              {{ robotA_battery | default(0) }}%
            </div>
          </div>
        </div>

      </div>

      <!-- ë¡œë´‡B -->
      <div class="card ">
        <div class="card-title">ë¡œë´‡B ìƒíƒœ</div>

        <div class="robot-row">
          <div><strong>ë°°í„°ë¦¬</strong></div>
          <div style="display:flex; align-items:center; gap:10px; width:70%;">
            <div class="progress">
                <div style="width: {{ robotB_battery}}%"></div>
            </div>

            <div style="min-width:52px; text-align:right;">
              {{ robotB_battery | default(0)}}%
            </div>
          </div>
        </div>

      </div>

    </section>

  </main>

  
  <div id="snackbar" style="
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #333;
    color: #fff;
    padding: 12px 16px;
    border-radius: 8px;
    display: none;
    z-index: 9999;
    font-size: 14px;">
  </div>

</body>

<script>
  // âœ… ì¶”ê°€: ë³µê·€ ìš”ì²­ API í˜¸ì¶œ
  document.getElementById("btnReturnHome")?.addEventListener("click", async () => {
    try {
      const res = await fetch("/api/return_home", { method: "POST" });
      const data = await res.json();

      if (!res.ok || !data.ok) throw new Error(data.error || "request failed");
      alert("ë³µê·€ ìš”ì²­ ì „ì†¡ ì™„ë£Œ");
      console.log(data)

    } catch (e) {
      console.error(e);
      alert("ë³µê·€ ìš”ì²­ ì‹¤íŒ¨");
    }
  });
</script>

<script>
  // dashboard ë“¤ì–´ì˜¤ë©´ ì¹´ë©”ë¼ ON ë³´ì¥
  fetch("/api/cameras/start", { method: "POST" }).catch(()=>{});
</script>

<script src="{{ url_for('static', filename='js/events.js') }}"></script>


<script>
  async function stopAlarm(){
    try{
      const res = await fetch("/api/alarm/stop", {method:"POST"});
      if(res.ok){
        // í•„ìš”í•˜ë©´ í† ìŠ¤íŠ¸/ìŠ¤ë‚µë°” í‘œì‹œ
        console.log("alarm stopped");
      }
    }catch(e){}
  }
</script>

<script>
  function clamp(n){ n = parseInt(n,10); return isNaN(n)?0:Math.max(0,Math.min(100,n)); }

  async function refreshStatus(){

    console.log('eaaergaergaerg')
    try{
      const res = await fetch("/api/status", {cache:"no-store"});
      if(!res.ok) return;
      const data = await res.json();

      const a = clamp(data.robotA_battery);
      const b = clamp(data.robotB_battery);

      document.getElementById("robotA_bar").style.width = a + "%";
      document.getElementById("robotA_text").textContent = a + "%";

      document.getElementById("robotB_bar").style.width = b + "%";
      document.getElementById("robotB_text").textContent = b + "%";

      // ì„ íƒ: ë°°í„°ë¦¬ ìƒ‰ ìë™ ë³€ê²½
      document.getElementById("robotA_bar").style.background = (a <= 20) ? "#ef4444" : "#22c55e";
      document.getElementById("robotB_bar").style.background = (b <= 20) ? "#ef4444" : "#f59e0b";

    }catch(e){}
  }

  refreshStatus(); // ì²« ë¡œë“œ ì¦‰ì‹œ ê°±ì‹ 
  setInterval(refreshStatus, 2000); // 2ì´ˆë§ˆë‹¤ ê°±ì‹ 
</script>

</html>
